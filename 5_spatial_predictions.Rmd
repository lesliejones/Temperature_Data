---
title: "5_spatial_predictions"
author: "Leslie"
date: "1/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(tidyverse)
library(rgdal)
library(lubridate)
```

# Predictions data frame

Read in spatial covariates associated with each RCA. These are stored in three separate feature classes.

```{r}
fgdb <- "Data/Spatial_data/Anchor/KFHP/Geodatabases/Anchor_LM_Outputs.gdb"

# List all feature classes in a file geodatabase
subset(ogrDrivers(), grepl("GDB", name))
fc_list <- ogrListLayers(fgdb)
print(fc_list)

rca_all2 <- sf::st_read(dsn = fgdb, layer = "anchor_rcas_31012020")

#Select attributes and rename for consistency with model
rca_all <- rca_all2 %>%  select(-Shape) %>% 
   rename(elev_mean_ca = Mean_Elev_Contributing_Area) %>% rename (elev_mean=MEAN) %>% rename(flowacc =     
    Flow_Accumulation) %>%  mutate(cont_area = flowacc * 25 / 1000000) %>% 
  select(rca_id, K_r, K_s, K_p, CH_r, CH_p, CH_s, CO_r, CO_s, CO_p, P_r, P_s, P_p, S_r, S_s, S_p, elev_mean, elev_mean_ca, cont_area, flowacc) 

rca_all <- data.frame(rca_all)


```

#add slope_P
```{r}

fgdb <- "Data/Spatial_data/Anchor/KFHP/Geodatabases/Anchor.gdb"

# List all feature classes in a file geodatabase
subset(ogrDrivers(), grepl("GDB", name))
fc_list <- ogrListLayers(fgdb)
print(fc_list)

# Read the feature class
rca_reach <- sf::st_read(dsn = fgdb, layer = "anch_rca_reaches")

reach <- rca_reach %>% select(reachid, slope_P, SLength, Z_Mean)

pred <- rca_all %>% left_join(reach, by = c("rca_id" = "reachid")) 
 

```

compare old flowmax to Dustin's
```{r}
contarea <- sf::st_read(dsn = fgdb, layer = "rca_cont_area")

flow <- contarea %>% select(rca_id, flowacc_max)

pred2 <- pred %>% left_join(flow, by = "rca_id") %>%  mutate(cont_area2 = flowacc_max * 25 / 1000000) %>% mutate(diff= cont_area2-cont_area) %>% select(rca_id, cont_area, cont_area2, flowacc_max, flowacc, diff)
```

#Filter salmon rcas only. This is the dataframe that we will predict on.Look at distribution of covariates that will predict over compared to rcas used in model parameterization.
```{r}
salmon_rcas <- pred %>% mutate(salmon = K_p + CH_p + P_p + CO_p + S_p) %>% filter(salmon > 0) 
nrow(salmon_rcas)

cov <- salmon_rcas %>% select(rca_id, elev_mean, elev_mean_ca, cont_area, slope_P)
summary(cov)

hist(salmon_rcas$elev_mean_ca)
hist(salmon_rcas$elev_mean)
hist(salmon_rcas$slope_P)
hist(salmon_rcas$cont_area)
```

Read in daymet data.

```{r}

#fgdb <- "Data/Spatial_data/Anchor/KFHP/Geodatabases/anchor_DAYMET.gdb"

# List all feature classes in a file geodatabase
#subset(ogrDrivers(), grepl("GDB", name))
#fc_list <- ogrListLayers(fgdb)
#print(fc_list)

# Read the feature class
#daymet <- sf::st_read(dsn = fgdb, layer = "anchor_daymet")

daymet_pred <- daymet %>% 
  mutate(date = as.Date(date), year= year(date), month = month(date), day=day(date)) 

```





