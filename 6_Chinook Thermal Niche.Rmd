---
title: "6_Thermal Niche"
author: "Leslie Jones"
date: "2/10/2020"
output:
  html_document:
    fig_width: 4
    fig_height: 4
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(tidyverse)
library(rgdal)
library(lubridate)
library(gridExtra)
library(arsenal)
library(knitr)
library(magick)
library(gganimate)
library(transformr)
```

# Exploring thermal niche for salmon

Load predictions data frame.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
load(file = "output/preds.Rdata")

#add month and decadal variable and filter on chinook
K_p <- preds %>% mutate(month=month(date)) %>% mutate(decade=case_when(year< 1990 ~ 1980, year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) %>% filter(K_p == 1)

K_s <- K_p %>% filter (K_s==1) %>% filter(month>=7)

K_r <- K_p %>% filter (K_r==1) %>% filter(month>=6 & month<=8)
```

Create Table summaries
https://cran.r-project.org/web/packages/arsenal/vignettes/tableby.html

```{r, results="asis", echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

#June summary
table_K_p6 <- K_p %>% filter(month==6) %>% select(preds, month, year, decade)
table1 <- tableby(decade ~ preds , data=table_K_p6)
summary(table1, title = "June Chinook spawning summary", text=TRUE)

#July summary
table_K_p7 <- K_p %>% filter(month==7) %>% select(preds, month, year, decade)
table1 <- tableby(decade ~ preds , data=table_K_p7)
summary(table1, title = "July Chinook spawning summary")

#August summary
table_K_p8 <- K_p %>% filter(month==8) %>% select(preds, month, year, decade)
table2 <- tableby(decade ~ preds , data=table_K_p8)
summary(table2, title = "August Chinook spawning summary")

#September summary
table_K_p9 <- K_p %>% filter(month==9) %>% select(preds, month, year, decade)
table3 <- tableby(decade ~ preds , data=table_K_p9)
summary(table3, title = "September Chinook spawning summary")

```


#Plot average daily temperatures across 38 year period
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align="center", fig.width=6, fig.asp=1}
#having trouble with filepath for ggsave - so overwriting working directory within each chunk
#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

#Chinook presence
mean_p <- K_p %>% group_by(day) %>% summarize(mean_day = mean(preds), sd_p = sd(preds)) 

ggplot(data=mean_p) +
  geom_smooth(aes(x = day, y = mean_day), show.legend = FALSE) + 
  ggtitle("Mean daily predictions 1980-2018 for Chinook presence habitat") 

ggsave("Chinook Presence: Mean daily temperature 1980-2018.jpeg",  plot=last_plot())

#Chinook spawning
mean_s <- K_s %>% group_by(day) %>% 
  summarize(mean_day = mean(preds), sd_p = sd(preds))

ggplot(data=mean_s) +
  geom_smooth(aes(x = day, y = mean_day), show.legend = FALSE) + 
  ggtitle("Mean daily predictions 1980-2018 for Chinook spawning") 

ggsave("Chinook Spawning: Mean daily temperature 1980-2018.jpeg", plot=last_plot())

#Chinook rearing
mean_r <- K_r %>% group_by(day) %>%
  summarize(mean_day = mean(preds), sd_p = sd(preds))
  
ggplot(data=mean_r) +
  geom_smooth(aes(x = day, y = mean_day), show.legend = FALSE) + 
  ggtitle("Mean daily predictions 1980-2018 for Chinook rearing") 

ggsave("Chinook Rearing: Mean daily temperature 1980-2018.jpeg", plot=last_plot())


```


Plot yearly summaries faceted by decade
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align="center", fig.width=6, fig.asp=1}
#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

# Summarize mean and sd of predictions by day and year - not sure how to retain variables when using the summarize function?? so create decade variable within

all_years <- K_p %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds))
  
ggplot(data=all_years) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE) + 
  ggtitle("Annual mean of daily predictions") 

ggsave("Annual means.jpeg", plot=last_plot())

decade <- K_p %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=decade) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), show.legend = FALSE) + facet_wrap(~decade) + 
  ggtitle("Annual mean of daily predictions by decade") 

ggsave("Annual means by decade.jpeg", plot=last_plot())

decade_noSE <- K_p %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=decade_noSE) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE) + facet_wrap(~decade) +
  ggtitle("Annual mean of daily predictions by decade no SE") 

ggsave("Annual means by decade no SE.jpeg", plot=last_plot())
```

Animate by Year using gganimate
https://www.datanovia.com/en/blog/gganimate-how-to-create-plots-with-beautiful-animation-in-r/
```{r}
#try gganimate method
#shadow fade with old years in background
theme_set(theme_bw())
ani <- ggplot(all_years, aes(x = day, y = mean_yr, color = as.factor(year))) +
  geom_smooth(se=FALSE, show.legend = FALSE) + 
  scale_size(range = c(2, 12)) +
  transition_states(year, transition_length = 1, state_length = 1) + shadow_mark(alpha=0.3, size=0.7) + 
  transition_time (year) + 
  labs(x = "Day of Year", y = "Daily mean Stream Temperature", title = "Year: {as.integer(frame_time)}")
  

animate(ani, duration=50, fps=1)

#try the "Let data gradually appear" with month time series
K_p2 <- preds %>% mutate(month=month(date), day2=(day(date))) %>% mutate(decade=case_when(year< 1990 ~ 1980, year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) %>% filter(K_p == 1)  

all_years2 <- K_p2 %>% group_by(month, day2) %>% 
  summarize(mean_mth = mean(preds))

ani2 <- ggplot(all_years2, aes(x = day2, y = mean_mth, color=factor(month))) +
  geom_line() +
  labs(x = "Day of Month", y = "Stream Temperature", title = "Average Daily Temperatures 1980-2018") 

ani2 + transition_reveal(day2)

```



Summarize predictions by decades and plot
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align="center", fig.width=6, fig.asp=1}
#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

#Summarize mean and sd of preds by day and decade
pred_decade <- K_p %>% group_by(decade, day) %>% 
  summarize(mean_dec = mean(preds), sd_dec = sd(preds))

ggplot(data=pred_decade) +
  geom_smooth(aes(x = day, y = mean_dec, color = as.factor(decade))) +
  ggtitle("Decadal mean of daily predictions") 

ggsave("Decadal mean of daily predictions.jpeg", plot=last_plot())

#Summarize mean and sd of preds by day and decade - no SE
pred_decade_noSE <- K_p %>% group_by(decade, day) %>% 
  summarize(mean_dec = mean(preds), sd_dec = sd(preds)) 

ggplot(data=pred_decade_noSE) +
  geom_smooth(aes(x = day, y = mean_dec, color = as.factor(decade)), se=FALSE) +
  ggtitle("Decadal mean of daily predictions no SE") 

ggsave("Decadal mean of daily predictions no SE.jpeg", plot=last_plot())


#Summarize mean and sd of preds by day and decade - facet by decade
pred_decade2 <- K_p %>% group_by(decade, day) %>% 
  summarize(mean_dec = mean(preds), sd_dec = sd(preds)) 

ggplot(data=pred_decade2) +
  geom_smooth(aes(x = day, y = mean_dec)) + facet_wrap(~decade)+
  ggtitle("Decadal mean of daily predictions") 

ggsave("Annual means by decade facet by decade.jpeg", plot=last_plot())

```


Calculate and plot Temperature Anomolies!
Calculate annual mean 1980-2018 then yearly differences between 38 year mean. 
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align="center", fig.width=6, fig.asp=1}
#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

#calculate average daily predictions over entire 38 year period 
pred_anom1 <- K_p %>% 
  group_by(day) %>% 
  summarize(mean38 = mean(preds), sd38 = sd(preds)) 

#calculate difference between 38 year average and daily prediction dataframe
pred_anom2 <- left_join(preds, pred_anom1) %>% mutate(anomoly=(mean38-preds))

#summarize anomolies by year and plot by decade
anomoly <- pred_anom2 %>% group_by(day, year) %>% 
  summarize(anom_yr = mean(anomoly)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=anomoly) +
  geom_smooth(aes(x = day, y = anom_yr, color = as.factor(year)), show.legend = FALSE) + facet_wrap(~decade) +
  ggtitle("Anomolies by day and year faceted by decade") 

ggsave("Anomolies by day and year faceted by decade.jpeg", plot=last_plot())


#summarize anomolies by year and plot by decade - no SE
anomoly_noSE <- pred_anom2 %>% group_by(day, year) %>% 
  summarize(anom_yr = mean(anomoly)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=anomoly_noSE) +
  geom_smooth(aes(x = day, y = anom_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE) + facet_wrap(~decade)  +
  ggtitle("Anomolies by day and year faceted by decade") 

ggsave("Anomolies by day and year no SE faceted by decade.jpeg", plot=last_plot())


```
#Filter for spawning time period - Chinook reach their spawning areas between July and September  - DESCENDING LIMB!!!!
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align="center", fig.width=6, fig.asp=1}
#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

# Summarize mean and sd of predictions by day and year - not sure how to retain variables when using the summarize function?? so create decade variable within

CH_s <- K_s %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) 

ggplot(data=CH_s) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE)  +
  ggtitle("Annual mean temperatures of Chinook spawning") 

ggsave("Annual mean temperatures of Chinook spawning.jpeg", plot=last_plot())

CH_s_dec <- K_s %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=CH_s_dec) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), show.legend = FALSE) + facet_wrap(~decade) +
  ggtitle("Annual mean temperatures of Chinook spawning faceted by decade") 

ggsave("Annual mean temperatures of Chinook spawning faceted by decade.jpeg", plot=last_plot())

CH_s_dec_noSE <- K_s %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=CH_s_dec_noSE) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE) + facet_wrap(~decade) +
  ggtitle("Annual mean temperatures of Chinook spawning faceted by decade no SE") 

ggsave("Annual mean temperatures of Chinook spawning faceted by decade no SE.jpeg", plot=last_plot())


```
#Filter for core rearing - June-August  
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align="center", fig.width=6, fig.asp=1}
#Change working directory to output plots
setwd("W:/GitHub/Temperature_Data/Anchor_chinook_plots")

# Summarize mean and sd of predictions by day and year - not sure how to retain variables when using the summarize function?? so create decade variable within

CH_r <- K_r %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) 

ggplot(data=CH_r) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE)+
  ggtitle("Annual mean temperatures of Chinook rearing") 

ggsave("Annual mean temperatures of Chinook rearing.jpeg", plot=last_plot())

CH_r_dec <- K_r %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=CH_r_dec) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), show.legend = FALSE) + facet_wrap(~decade)+
  ggtitle("Annual mean temperatures of Chinook rearing faceted by decade") 

ggsave("Annual mean temperatures of Chinook rearing faceted by decade.jpeg", plot=last_plot())

CH_r_dec_noSE <- K_r %>% group_by(day, year) %>% 
  summarize(mean_yr = mean(preds), sd_yr = sd(preds)) %>% mutate(decade=case_when(year< 1990 ~ 1980, 
  year >= 1990 & year < 2000 ~ 1990, year >=2000 & year < 2010 ~ 2000, year>2009 ~ 2010)) 

ggplot(data=CH_r_dec_noSE) +
  geom_smooth(aes(x = day, y = mean_yr, color = as.factor(year)), se=FALSE, show.legend = FALSE) + facet_wrap(~decade)+
  ggtitle("Annual mean temperatures of Chinook rearing faceted by decade no SE") 

ggsave("Annual mean temperatures of Chinook rearing faceted by decade no SE.jpeg", plot=last_plot())


```
