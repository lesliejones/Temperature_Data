---
title: "2_model exploration"
author: "Leslie Jones"
date: "1/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE)

library(lubridate)
library(rgdal)
library(zoo)
library(sf)
library(corrplot)
library(MuMIn)
library(ape)
library(readxl)
#library(VIF)
library(tidyverse)
#library(jtools)
```

# Database for Anchor Model
Load data frame from 1_Creat model data frame.Rmd

```{r}
load(file = "output/temp.dm.Rdata")

```


## Compare LST versus daymet air temperatures

See correlation between lst and daymet.
Test models of stream temp with each.

```{r}

cor(temp.dm$lst2, temp.dm$tair, use = "pairwise.complete.obs")

temp.dm %>% 
  ggplot() +
  geom_point(aes(x = tair, y = lst2)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_x_continuous(limits = c(0, 25)) +
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~month)


```

plot LST versus stream temperature.

```{r}
temp.dm %>% 
  ggplot() +
  geom_point(aes(x = lst2, y = ma_mean, color = as.factor(month))) +
  facet_wrap(~Site) 

```



```{r}
temp.dm %>% 
  filter(!is.na(LST)) %>% 
  summarize(clm = cor(lst2, ma_mean),
            cam = cor(tair, ma_mean))


lm1 <- lm(ma_mean ~ tair, data = temp.dm %>% filter(!is.na(LST)))
lm2 <- lm(ma_mean ~ lst2, data = temp.dm %>% filter(!is.na(LST)))
AIC(lm1, lm2)

```



## Explore correlations between the covariates

```{r}
temp.rca %>% 
  distinct(reach_slope, reach_length, rca_elev_min, rca_elev_max, rca_elev_mn, ca_elev_mn, cont_area) %>% 
  cor(.) %>% 
  corrplot.mixed(.)
```


For now, keep all three elevation covariates, but may need to drop one later. Also keep slope in percent, and contributing area. Convert flow accumulation to square meters to square kilometers for contributing area. 1 cell = 25 square meters and 1 square kilometer = 1,000,000 square meters.

See email from Leslie on 12-20-19: "use the slope_P (percent) or slope_D (degrees) for the model. Upstream Contributing Area: Maximum flow accumulation value for RCA * multiplied by cell size."

```{r}
temp.rca <- temp.rca %>% 
  select(Site, rca_id, sampleDate, meanT, ma_mean, slope_P, elev_mean, elev_mean_ca, 
         elev_delta, flowacc_max) %>% 
  mutate(cont_area = flowacc_max * 25 / 1000000)
```

Double check. Great! Maximum flow accumulation near the mouth is 580 km2 and HUC10 is 585.

```{r}
temp.rca %>% 
  distinct(cont_area, rca_id, Site) %>% 
  arrange(desc(cont_area))
```


Remove April

```{r}

#remove April
temp.dm1 <- filter(temp.dm, month > 4)

```



## Exploratory Graphs

### Correlation between LST and air temperature by month
```{r, echo=FALSE, warnings = FALSE}
temp.dm %>%
  group_by(month) %>%
  summarise(cor = cor(lst2, tair, use = "pairwise.complete.obs"))
```

### correlation between stream temp and air temperature by month
```{r, echo=FALSE, warnings = FALSE}
temp.dm %>%
  group_by(month) %>%
  summarise(cor = cor(ma_mean, tair ))
```

### correlation and plot between stream temp and LST by month
```{r, echo=FALSE, warnings = FALSE}
temp.dm %>%
  group_by(month) %>%
  summarise(cor = cor(ma_mean, lst2, use = "pairwise.complete.obs"))

temp.dm %>% 
  ggplot() +
  geom_point(aes(x = lst2, y = ma_mean, color = as.factor(month))) +
  facet_wrap(~Site) 
```

### plot air temperature and LST by month
```{r, echo=FALSE, warnings = FALSE}
temp.dm %>% 
  ggplot() +
  geom_point(aes(x = tair, y = lst2)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_x_continuous(limits = c(0, 25)) +
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~month)

```
### plot air temperature and stream temperature by month

```{r, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}
temp.dm %>% 
  ggplot() +
  geom_point(aes(x = tair, y = ma_mean)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_x_continuous(limits = c(0, 25)) +
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~month)

month5 <- filter(temp.dm,month==5)   
  ggplot() +
  geom_point(data=month5, aes(x = day, y = ma_mean, color=year)) +
  scale_y_continuous(limits = c(0, 31)) + 
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~Site, scales="free")
  
  month6 <- filter(temp.dm,month==6)   
  ggplot() +
  geom_point(data=month6, aes(x = day, y = ma_mean, color=year)) +
  scale_y_continuous(limits = c(0, 31)) + 
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~Site, scales="free")
  
  month7 <- filter(temp.dm,month==7)   
  ggplot() +
  geom_point(data=month7, aes(x = day, y = ma_mean, color=year)) +
  scale_y_continuous(limits = c(0, 31)) + 
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~Site, scales="free")
  
   month8 <- filter(temp.dm,month==8)   
  ggplot() +
  geom_point(data=month8, aes(x = day, y = ma_mean, color=year)) +
  scale_y_continuous(limits = c(0, 31)) + 
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~Site, scales="free")
  
  month9 <- filter(temp.dm,month==9)   
  ggplot() +
  geom_point(data=month9, aes(x = day, y = ma_mean, color=year)) +
  scale_y_continuous(limits = c(0, 31)) + 
  scale_y_continuous(limits = c(0, 25)) +
  facet_wrap(~Site, scales="free")

```


## Exploratory Modeling

Try out sets of models.

```{r, echo=FALSE}

corrplot.mixed(cor(temp %>% select(ma_mean, tair, prcp, swe, slope_P, elev_mean, cont_area, wetland, forest, shrub)))

#model1 <- lm(ma_mean ~ tair, data=temp.mod)
#model2 <- lm(ma_mean ~ tair + elev_mean, data=temp.mod)
#model3 <- lm(ma_mean ~ tair + elev_mean + slope_P, data=temp.mod)
#model4 <- lm(ma_mean ~ tair + elev_mean + slope_P + cont_area, data=temp.mod)
#model5 <- lm(ma_mean ~ tair + elev_mean + slope_P + cont_area + prcp, data=temp.mod)
#AIC(model1, model2, model3, model4, model5)

#make month a factor
month.f <- factor(temp$month)
is.factor(temp$month.f)

full.model <- lm(ma_mean ~ tair + month*tair + slope_P + elev_mean + cont_area + month.f + wetland + shrub +forest, data = temp,
                na.action = "na.fail")

dredge(full.model)

chosen.model <- lm(ma_mean ~ tair  + month*tair  + slope_P + elev_mean + cont_area + forest + shrub + wetland  , data = temp,
                na.action = "na.fail")
summary(chosen.model)
plot(chosen.model)
summ(chosen.model,confint = TRUE, digits = 3)

#save predicted an residual
temp$predicted <- predict(chosen.model)
temp$residuals <- residuals(chosen.model)
hist(temp$residuals)
ggplot(data = temp, aes(x= ma_mean, y=predicted, colour=year)) + geom_point()
ggplot(data = temp, aes(x= ma_mean, y=predicted, colour=Site)) + geom_point()

ggplot(data = temp, aes(x= ma_mean, y=residuals, color=Site)) + geom_point()
ggplot(data = temp, aes(x= day, y=residuals, group=year, color=year)) + geom_point()+ facet_wrap(~Site)
ggplot(data = temp, aes(x= day, y=ma_mean, group=year, color=year)) + geom_point()+ facet_wrap(~Site)

#check out high residuals
resid <- temp %>% filter(residuals > 3)
ggplot(data = resid, aes(x= ma_mean, y=residuals, color=Site)) + geom_point()
ggplot(data = resid, aes(x= ma_mean, y=predicted, color=Site)) + geom_point()

#star <- temp %>% filter(Site=='STAR 171 Lower') 
#ggplot(data=resid, aes(y=ma_mean, x=sampleDate)) + geom_point()



```
### Investigate model by month to see how coefficients behave
June Model
```{r}
June <- temp %>% filter(month==6)
full.modelJ <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + wetland + shrub +forest, data = June,
                na.action = "na.fail")

dredge(full.modelJ)

chosen.modelJ <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + forest + shrub + wetland  , data = June,
                na.action = "na.fail")
summary(chosen.modelJ)
summ(chosen.modelJ,confint = TRUE, digits = 3)
```
### Investigate model by month to see how coefficients behave
July Model
```{r}
July <- temp %>% filter(month==7)
full.modelJY <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + wetland + shrub +forest, data = July,
                na.action = "na.fail")

dredge(full.modelJY)

chosen.modelJY <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + forest + shrub + wetland  , data = July,
                na.action = "na.fail")
summary(chosen.modelJY)
summ(chosen.modelJY, confint = TRUE, digits = 3)
```

### Investigate model by month to see how coefficients behave
August Model
```{r}
August <- temp %>% filter(month==8)
full.modelA <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + wetland + shrub +forest, data = August,
                na.action = "na.fail")

dredge(full.modelA)

chosen.modelA <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + forest + shrub + wetland  , data = August,
                na.action = "na.fail")
summary(chosen.modelA)
summ(chosen.modelA, confint = TRUE, digits = 3)
```

### Investigate model by month to see how coefficients behave
September Model
```{r}
Sept <- temp %>% filter(month==9)
full.modelS <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + wetland + shrub +forest, data = Sept,
                na.action = "na.fail")

dredge(full.modelS)

chosen.modelS <- lm(ma_mean ~ tair + slope_P + elev_mean + cont_area + forest + shrub + wetland  , data = Sept,
                na.action = "na.fail")
summary(chosen.modelS)
summ(chosen.modelS, confint = TRUE, digits = 3)
```


## SAVE DATAFRAME for model development

```{r}
save(temp, file = "output/temp.Rdata")

```